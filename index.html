<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gran Rifa Mega Fortuna</title>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* Estilos generales del HTML y BODY */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
        }

        body {
            font-family: 'Poppins', sans-serif; /* Fuente principal para el cuerpo */
            background: linear-gradient(to right, #6a0dad, #228B22); /* Degradado original */
            color: white;
            text-align: center;
            flex: 1 0 auto;
            transition: background 0.5s ease, color 0.5s ease;
        }

        main {
            flex: 1 0 auto;
        }

        h1 {
            font-family: 'Montserrat', sans-serif; /* Fuente para los t√≠tulos */
            font-size: 3rem;
            margin-top: 2rem;
            text-shadow: 2px 2px 5px black;
            transition: text-shadow 0.5s ease;
        }

        /* Estilos de botones generales */
        .btn {
            padding: 1rem 2rem;
            font-size: 1.5rem;
            margin: 1rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s, background-color 0.3s, box-shadow 0.3s;
        }

        .btn:hover {
            transform: scale(1.05);
        }

        /* Estilos espec√≠ficos del bot√≥n "Comprar" */
        .comprar {
            background-color: #32cd32; /* Verde brillante */
            color: white;
            box-shadow: 0 0 15px rgba(50, 205, 50, 0.7); /* Sombra que brilla */
            animation: pulseEffect 2s infinite; /* Aplica la animaci√≥n */
        }

        .comprar:hover {
            background-color: #3CB371; /* Verde un poco m√°s claro al pasar el mouse */
        }

        /* Estilos espec√≠ficos del bot√≥n "Reportar" */
        .reportar {
            background-color: #8a2be2; /* Morado azulado */
            color: white;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        .reportar:hover {
            background-color: #9932CC; /* Morado un poco m√°s claro al pasar el mouse */
        }

        /* Estilos para el bot√≥n de Pagar (anteriormente showPaymentDetailsBtn) */
        .pay-button {
            background-color: #FFD700; /* Dorado */
            color: #333; /* Texto oscuro para contraste */
            padding: 1.2rem 2.5rem; /* M√°s grande */
            font-size: 1.8rem; /* Fuente m√°s grande */
            border-radius: 15px; /* Bordes m√°s redondeados */
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.8); /* Sombra m√°s brillante y dorada */
            animation: pulseEffectGolden 2s infinite; /* Nueva animaci√≥n de pulso dorada */
            width: 80%; /* Hacerlo m√°s ancho dentro del modal */
            max-width: 300px; /* Ancho m√°ximo para que no sea excesivamente grande */
            margin: 20px auto; /* Centrarlo con margin auto */
            display: block; /* Para que margin auto funcione */
        }

        .pay-button:hover {
            background-color: #FFC400; /* Dorado m√°s oscuro al pasar el mouse */
            transform: scale(1.08); /* Efecto de escala m√°s pronunciado */
            box-shadow: 0 0 30px rgba(255, 215, 0, 1); /* Sombra a√∫n m√°s brillante */
        }

        /* Animaci√≥n de pulso para el bot√≥n comprar */
        @keyframes pulseEffect {
            0% {
                transform: scale(1);
                box-shadow: 0 0 15px rgba(50, 205, 50, 0.7);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 0 25px rgba(50, 205, 50, 1); /* M√°s brillo en el medio */
            }
            100% {
                transform: scale(1);
                box-shadow: 0 0 15px rgba(50, 205, 50, 0.7);
            }
        }

        /* Nueva animaci√≥n de pulso para el bot√≥n de Pagar (dorado) */
        @keyframes pulseEffectGolden {
            0% {
                transform: scale(1);
                box-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
            }
            50% {
                transform: scale(1.08);
                box-shadow: 0 0 40px rgba(255, 215, 0, 1.2); /* M√°s brillo y alcance */
            }
            100% {
                transform: scale(1);
                box-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
            }
        }

        /* Estilos de modales */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.6);
            justify-content: center;
            align-items: center;
            z-index: 999;
        }

        .modal-content {
            background: white;
            color: black;
            padding: 2rem;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
            transition: background 0.5s ease, color 0.5s ease, box-shadow 0.5s ease;
            max-height: 90vh; /* Limitar altura del modal */
            overflow-y: auto; /* Permitir scroll si el contenido es largo */
            display: flex; /* A√±adido para mejor control del contenido */
            flex-direction: column; /* Contenido en columna */
            align-items: center; /* Centrar items */
        }

        .modal-content h2 {
            margin-top: 0;
            color: inherit; /* Hereda el color del texto del modal-content */
        }

        input, select {
            width: 100%;
            padding: 0.5rem;
            margin: 0.5rem 0;
            border-radius: 5px;
            border: 1px solid #ccc;
            transition: background-color 0.5s ease, color 0.5s ease, border-color 0.5s ease;
        }

        .modal-content button {
            margin-top: 1rem;
            padding: 0.7rem 1.5rem;
            border: none;
            background-color: #6a0dad;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .modal-content button:hover {
            background-color: #5b00b7;
        }
        
        /* Estilos del footer */
        footer {
            flex-shrink: 0;
            background-color: rgba(0,0,0,0.3);
            color: white;
            font-size: 0.9rem;
            text-align: center;
            padding: 1rem 0;
            transition: background-color 0.5s ease, color 0.5s ease;
        }

        /* Estilos de la barra superior */
        .top-bar {
            display: flex;
            align-items: center;
            background-color: #4b0082; /* morado oscuro */
            padding: 0.3rem 1rem;
            border-bottom: 3px solid #32cd32; /* l√≠nea verde */
            height: 40px;
            overflow: hidden;
            transition: background-color 0.5s ease, border-color 0.5s ease;
        }

        .logo {
            height: 40px; /* Ajustado el tama√±o del logo */
            width: auto;
            margin-right: 1rem;
        }

        .marquee-container {
            flex: 1;
            overflow: hidden;
            white-space: nowrap;
        }

        .marquee-text {
            display: inline-block;
            padding-left: 100%;
            animation: marquee 15s linear infinite;
            font-weight: bold;
            color: #32cd32; /* verde brillante */
            text-shadow: 0 0 5px #32cd32;
            transition: color 0.5s ease, text-shadow 0.5s ease;
        }

        @keyframes marquee {
            0% {
                transform: translateX(0%);
            }
            100% {
                transform: translateX(-100%);
            }
        }

        /* --- Estilos para el Loader --- */
        #loader-wrapper {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to right, #6a0dad, #228B22); /* Colores de tu p√°gina */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999; /* Asegura que est√© por encima de todo */
            opacity: 1;
            visibility: visible;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }

        #loader-wrapper.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .loader {
            border: 8px solid rgba(255, 255, 255, 0.3); /* Color claro para el borde interior */
            border-top: 8px solid #32cd32; /* Verde m√°s brillante para la parte que gira */
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite; /* Animaci√≥n de giro */
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* --- Fin de Estilos para el Loader --- */

        /* Nuevos estilos para el modal de selecci√≥n de tickets */
        #ticketSelectionModal .modal-content {
            max-width: 800px; /* M√°s ancho para mostrar tickets */
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #ticketGrid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); /* Columnas responsivas */
            gap: 8px;
            margin-top: 20px;
            max-height: 50vh; /* Limitar la altura de la cuadr√≠cula de tickets */
            overflow-y: auto; /* Scroll dentro de la cuadr√≠cula */
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 8px;
            width: 100%; /* Asegurar que ocupe todo el ancho disponible */
        }

        .ticket-item {
            width: 50px;
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            color: white; /* Texto blanco para todos los tickets */
            font-size: 0.9em;
        }

        .ticket-item.available {
            background-color: #32cd32; /* Verde para disponible */
        }

        .ticket-item.selected {
            background-color: #6a0dad; /* Morado para seleccionado (cambia del verde) */
            transform: scale(1.05);
            border: 2px solid #fff;
        }

        .ticket-item.sold {
            background-color: #dc3545; /* Rojo para vendido */
            cursor: not-allowed;
            opacity: 0.7;
        }
        #selectedTicketsDisplayModal { /* Renombrado para evitar conflicto con #selectedTicketsInfo */
            margin-top: 15px;
            font-size: 1.1em;
            font-weight: bold;
            color: #333;
            width: 100%;
            text-align: left;
        }
        #currentTicketsCount {
            font-size: 1em;
            color: #555;
            margin-top: 5px;
            width: 100%;
            text-align: left;
        }
        #ticketSelectionModal button {
            width: auto;
            padding: 0.8rem 1.8rem;
            margin: 10px;
        }

        /* Estilos para el nuevo mensaje de respuesta */
        #responseMessage {
            margin-top: 20px;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
            text-align: center;
            color: black; /* Default color */
            background-color: transparent; /* Default background */
        }
        /* Estilos para las opciones de pago (nuevos contenedores) */
        .payment-option-container {
            border: 1px solid #ddd;
            padding: 15px;
            margin-top: 20px;
            border-radius: 8px;
            background-color: #f0f8ff; /* Un color suave para diferenciar */
            text-align: left;
            width: 90%; /* Ajustar al ancho del modal content */
            max-width: 450px; /* Asegurar que no sea demasiado grande */
            margin-bottom: 15px; /* Espacio entre opciones */
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            color: #333;
        }

        .payment-option-container h3 {
            color: #4b0082; /* Morado oscuro para los t√≠tulos */
            margin-top: 0;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            text-align: center;
            font-size: 1.3em;
        }
        .payment-option-container p {
            margin-bottom: 5px;
            font-size: 1em;
        }
        .payment-option-container strong {
            color: #6a0dad; /* Morado para los labels */
        }

        .copy-button {
            background-color: #32cd32; /* Verde del bot√≥n comprar */
            color: white;
            padding: 0.6rem 1.2rem;
            font-size: 0.9em;
            border-radius: 5px;
            margin-top: 10px;
            cursor: pointer;
            transition: background-color 0.2s;
            display: block; /* Para que ocupe todo el ancho disponible y se centre si es necesario */
            width: fit-content; /* Se ajusta al contenido */
            margin-left: auto; /* Centrar el bot√≥n */
            margin-right: auto; /* Centrar el bot√≥n */
        }

        .copy-button:hover {
            background-color: #28a745; /* Verde m√°s oscuro al pasar el mouse */
        }

        /* Estilo para el mensaje de copia */
        .copy-message {
            font-size: 0.8em;
            color: green;
            margin-top: 5px;
            text-align: center;
        }

        /* --- NUEVOS ESTILOS PARA LA SECCI√ìN DE CONTACTO --- */
        .contact-section {
            background-color: rgba(0, 0, 0, 0.4); /* Fondo semi-transparente oscuro */
            padding: 1.5rem;
            margin-top: 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            color: white;
            text-align: center;
        }

        .contact-section h2 {
            font-family: 'Montserrat', sans-serif;
            font-size: 2rem;
            color: #FFD700; /* Dorado para el t√≠tulo de contacto */
            margin-bottom: 1rem;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
        }

        .contact-section p {
            font-size: 1.1rem;
            margin-bottom: 1.5rem;
            line-height: 1.4;
        }

        .whatsapp-button {
            display: inline-flex; /* Para alinear el √≠cono y el texto */
            align-items: center;
            background-color: #25D366; /* Color de WhatsApp */
            color: white;
            padding: 0.8rem 1.5rem;
            margin: 0.5rem;
            border-radius: 25px; /* Bordes m√°s redondeados */
            text-decoration: none;
            font-size: 1.2rem;
            font-weight: bold;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        .whatsapp-button:hover {
            background-color: #1DA851; /* Verde m√°s oscuro al pasar el mouse */
            transform: translateY(-2px); /* Peque√±o efecto de levantamiento */
            box-shadow: 0 6px 15px rgba(0,0,0,0.3);
        }

        .whatsapp-button i {
            margin-right: 8px; /* Espacio entre el √≠cono y el texto */
            font-size: 1.5rem; /* Tama√±o del √≠cono */
        }
    </style>
</head>
<body>
    <div id="loader-wrapper">
        <div class="loader"></div>
    </div>

    <header class="top-bar">
        <img src="https://i.imgur.com/icCo1me.jpeg" alt="Logo Agencia" class="logo" />
        <div class="marquee-container">
            <p class="marquee-text">¬°Bienvenido a Agencia de Rifas Gran Fortuna! Compra tus tickets y participa hoy mismo. ¬°Suerte para todos! üéâ</p>
        </div>
    </header>

    <main>
        <h1>Gran Rifa Mega Fortuna</h1>
        <button class="btn comprar" onclick="openPurchaseModal()">Compra tu ticket aqu√≠</button>
        <button class="btn reportar" onclick="openModal('reportModal')">Reportar Pago</button>

        <div class="contact-section">
            <h2>¬øTienes dudas? ¬°Cont√°ctanos!</h2>
            <p>Estamos aqu√≠ para ayudarte. Si tienes alguna pregunta sobre la rifa, tu compra o cualquier otra consulta, no dudes en escribirnos.</p>
            <div>
                <a href="https://wa.me/584121234567" target="_blank" class="whatsapp-button">
                    <i class="fab fa-whatsapp"></i> WhatsApp Soporte 1
                </a>
                <a href="https://wa.me/584247654321" target="_blank" class="whatsapp-button">
                    <i class="fab fa-whatsapp"></i> WhatsApp Soporte 2
                </a>
            </div>
        </div>
        <div class="modal" id="comprarModal">
            <div class="modal-content">
                <h2>Formulario de Compra</h2>
                <form id="raffleForm"> 
                    <input type="text" placeholder="Nombre" id="nombre" name="nombre" required />
                    <input type="text" placeholder="Apellido" id="apellido" name="apellido" required />
                    <input type="text" placeholder="C√©dula" id="cedula" name="cedula" required pattern="[VEGJPvegjp]{1}-\d{7,8}|\d{7,8}" title="Formato: V-12345678 o 12345678"/>
                    <input type="tel" placeholder="Tel√©fono" id="telefono" name="telefono" required pattern="\d{10,11}" title="Formato: 04121234567"/>
                    <input type="email" placeholder="Correo" id="correo" name="correo" required />
                    
                    <button type="button" id="selectTicketsBtn" onclick="openTicketSelectionModal()">Seleccionar Tickets</button>
                    <div id="selectedTicketsInfo" style="margin-top: 10px; font-weight: bold; color: #555; text-align: left; width: 100%;">
                        <p>Tickets seleccionados: <span id="displaySelectedTickets">Ninguno</span></p>
                        <p id="montoDisplay">Monto a pagar: Bs. 0</p>
                    </div>

                    <button type="button" id="showPaymentDetailsBtn" class="pay-button">Pagar</button> 
                    
                    <div id="paymentOptionsContainer" style="display: none; width: 100%; text-align: center;">
                        <p style="font-size: 1.1em; font-weight: bold; margin-bottom: 15px; color: #6a0dad;">Selecciona tu m√©todo de pago:</p>

                        <div class="payment-option-container">
                            <h3>Pago M√≥vil (Banesco)</h3>
                            <p><strong>Banco:</strong> <span id="pm1Bank">Banesco</span></p>
                            <p><strong>C√©dula:</strong> <span id="pm1Cedula">V-12345678</span></p>
                            <p><strong>Tel√©fono:</strong> <span id="pm1Phone">0412-1234567</span></p>
                            <p><strong>Monto:</strong> <span id="pm1Monto">Bs. 0</span></p>
                            <button type="button" class="copy-button" onclick="copyPaymentData('pm1')">Copiar Datos Pago M√≥vil 1</button>
                            <div class="copy-message" id="pm1CopyMessage"></div>
                        </div>

                        <div class="payment-option-container">
                            <h3>Pago M√≥vil (Banco Venezuela)</h3>
                            <p><strong>Banco:</strong> <span id="pm2Bank">Banco de Venezuela</span></p>
                            <p><strong>C√©dula:</strong> <span id="pm2Cedula">V-87654321</span></p>
                            <p><strong>Tel√©fono:</strong> <span id="pm2Phone">0424-7654321</span></p>
                            <p><strong>Monto:</strong> <span id="pm2Monto">Bs. 0</span></p>
                            <button type="button" class="copy-button" onclick="copyPaymentData('pm2')">Copiar Datos Pago M√≥vil 2</button>
                            <div class="copy-message" id="pm2CopyMessage"></div>
                        </div>

                        <p style="font-size: 0.9em; color: #555; margin-top: 15px;">Por favor, realiza el pago a los datos elegidos y luego haz clic en "Enviar Registros".</p>
                    </div>

                    <button type="submit" id="submitRaffleFormBtn" style="display: none; margin-top: 10px;">Enviar Registros</button>
                </form>

                <div id="raffleFormResponseMessage" style="margin-top: 20px; padding: 10px; border-radius: 5px; font-weight: bold;"></div>

                <button onclick="closeModal('comprarModal')">Cerrar Formulario</button>
            </div>
        </div>

        <div class="modal" id="ticketSelectionModal">
            <div class="modal-content">
                <h2>Selecciona tu n√∫mero de Ticket</h2>
                <div id="selectedTicketsDisplayModal" style="margin-bottom: 10px; font-weight: bold; color: #333; text-align: left; width: 100%;">
                    Tickets seleccionados: <span id="currentSelectedTickets">Ninguno</span>
                    <p id="currentTicketsCount">0 tickets</p>
                </div>
                <div id="ticketGrid">
                </div>
                <p style="font-size: 0.9em; color: #777; margin-top: 15px;">M√≠nimo 2 tickets.</p>
                <button onclick="confirmTicketSelection()">Confirmar Selecci√≥n</button>
                <button onclick="cancelTicketSelection()">Cancelar</button>
            </div>
        </div>

        <div class="modal" id="reportModal">
            <div class="modal-content">
                <h2>Ingrese los datos de su pago</h2>
                <input type="text" id="cedulaReporte" placeholder="C√©dula" />
                <input type="tel" id="telefonoReporte" placeholder="Tel√©fono" />
                <input type="email" id="correoReporte" placeholder="Correo" />
                <input type="text" id="referencia" placeholder="Referencia (√∫ltimos 6 d√≠gitos)" />
                <select id="bancoEmisor">
                    <option disabled selected value="">Seleccione banco emisor</option>
                    <option value="0102 - Banco de Venezuela">0102 - Banco de Venezuela</option>
                    <option value="0104 - Banco Venezolano de Cr√©dito">0104 - Venezolano de Cr√©dito</option>
                    <option value="0105 - Banco Mercantil">0105 - Mercantil</option>
                    <option value="0108 - Banco Provincial">0108 - Provincial</option>
                    <option value="0114 - Banesco">0114 - Banesco</option>
                    <option value="0115 - Banco Exterior">0115 - Exterior</option>
                    <option value="0134 - BNC">0134 - BNC</option>
                    <option value="0137 - Sofitasa">0137 - Sofitasa</option>
                    <option value="0172 - Bancamiga">0172 - Bancamiga</option>
                    <option value="0174 - Banplus">0174 - Banplus</option>
                    <option value="0175 - Banco Bicentenario">0175 - Bicentenario</option>
                    <option value="0191 - Banco Nacional de Cr√©dito">0191 - BNC</option>
                </select>
                <button onclick="enviarReporte()">Enviar datos del pago</button>
                <button onclick="closeModal('reportModal')">Cancelar</button>
            </div>
        </div>
    </main>

    <footer>
        &copy; 2025 Gran Rifa Mega Fortuna ‚Äî Creado por Agencia de Rifas Gran Fortuna
    </footer>

    <script>
    // ** IMPORTANTE: REEMPLAZA ESTA URL CON LA URL DE DESPLIEGUE DE TU APPS SCRIPT (doPost) **
    // Esta es la URL de tu proyecto "WebFormularioDeRifa" en Google Apps Script
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxek62igDKzLfqQWFZ2ty1PV8bRoSm4BW1_UZ_3wYhMXX4cASpZBblqp2d74uWI-mA/exec"; // <-- ¬°ACTUALIZA ESTO!

    let tasaDolar = 0;
    const precioTicketUSD = 1;
    
    // Datos para Pago M√≥vil 1 (Banesco)
    const cedulaPM1 = "V-12345678"; 
    const telefonoPM1 = "0412-1234567";
    const bankPM1 = "Banesco"; 

    // Datos para Pago M√≥vil 2 (Banco de Venezuela)
    const cedulaPM2 = "V-87654321"; 
    const telefonoPM2 = "0424-7654321";
    const bankPM2 = "Banco de Venezuela"; 

    // N√∫meros de WhatsApp para contacto (con c√≥digo de pa√≠s sin el +) - A√±adido desde el segundo c√≥digo
    const whatsappNumber1 = "584121234567"; 
    const whatsappNumber2 = "584247654321"; 

    const TOTAL_TICKETS = 10000; // Total de tickets disponibles
    const MIN_TICKETS_PURCHASE = 2; // Compra m√≠nima

    let soldTickets = new Set(); // Almacena los tickets ya vendidos
    let selectedTickets = new Set(); // Tickets seleccionados por el usuario en el modal

    // Referencia al loader
    const loaderWrapper = document.getElementById('loader-wrapper');

    // Funci√≥n para mostrar el loader
    function showLoader() {
        loaderWrapper.classList.remove('hidden');
    }

    // Funci√≥n para ocultar el loader
    function hideLoader() {
        loaderWrapper.classList.add('hidden');
    }

    // === NUEVA FUNCI√ìN PARA OBTENER LA TASA DESDE open.er-api.com ===
async function obtenerTasaDolar() {
    showLoader(); // Muestra el loader
    try {
        const response = await fetch("https://open.er-api.com/v6/latest/USD");
        if (!response.ok) throw new Error("Error en la solicitud a la API.");

        const data = await response.json();
        const tasa = data?.rates?.VES;

        if (typeof tasa === "number" && tasa > 0) {
            tasaDolar = parseFloat(tasa);
        } else {
            console.warn("La API respondi√≥ pero no hay tasa v√°lida. Usando valor por defecto (100).");
            tasaDolar = 100;
        }

    } catch (error) {
        console.error("Error al obtener la tasa del d√≥lar desde la API:", error);
        tasaDolar = 100; // Valor por defecto
        alert("Advertencia: No se pudo obtener la tasa de cambio actual. Se usar√° Bs. 100 por d√≥lar.");
    } finally {
        calcularMonto(); // Llama a tu funci√≥n de c√°lculo
        hideLoader();    // Oculta el loader
    }
}
    // === FIN MODIFICACI√ìN CLAVE ===


    function openModal(id) {
        document.getElementById(id).style.display = "flex";
    }

    function closeModal(id) {
        document.getElementById(id).style.display = "none";
    }

    // Nueva funci√≥n para abrir el modal de compra principal
    function openPurchaseModal() {
        // Reinicia la selecci√≥n de tickets al abrir el modal principal de compra
        selectedTickets.clear();
        updateSelectedTicketsInfo(); // Actualiza el display de tickets seleccionados
        
        // Restablecer el estado inicial del formulario de compra y sus botones/mensajes
        const raffleForm = document.getElementById('raffleForm');
        raffleForm.reset(); // Limpia los campos del formulario
        
        document.getElementById('paymentOptionsContainer').style.display = 'none'; // Oculta info de pago
        document.getElementById('submitRaffleFormBtn').style.display = 'none'; // Oculta bot√≥n de enviar
        document.getElementById('showPaymentDetailsBtn').style.display = 'block'; // Muestra bot√≥n "Pagar"
        document.getElementById('showPaymentDetailsBtn').disabled = false; // Asegura que no est√© deshabilitado

        const raffleFormResponseMessage = document.getElementById('raffleFormResponseMessage');
        raffleFormResponseMessage.textContent = ''; // Limpia mensajes previos
        raffleFormResponseMessage.style.backgroundColor = 'transparent';
        raffleFormResponseMessage.style.color = 'black';

        // Limpiar mensajes de copia
        document.getElementById('pm1CopyMessage').textContent = '';
        document.getElementById('pm2CopyMessage').textContent = '';


        openModal('comprarModal');
    }

    function calcularMonto() {
        const cantidad = selectedTickets.size;
        let montoBs = 0;
        if (cantidad >= MIN_TICKETS_PURCHASE && tasaDolar > 0) {
            montoBs = (cantidad * precioTicketUSD * tasaDolar).toFixed(2);
        }
        document.getElementById("montoDisplay").innerText = `Monto a pagar: Bs. ${montoBs}`;
        
        // Actualiza los montos en las opciones de pago m√≥vil
        document.getElementById("pm1Monto").innerText = `Bs. ${montoBs}`;
        document.getElementById("pm2Monto").innerText = `Bs. ${montoBs}`;
    }

    // Funci√≥n para actualizar el display de tickets seleccionados en el formulario de compra
    function updateSelectedTicketsInfo() {
        const display = document.getElementById('displaySelectedTickets');
        const selectedArr = Array.from(selectedTickets).sort((a, b) => a - b); // Ordenar para mejor visualizaci√≥n
        display.innerText = selectedArr.length > 0 ? selectedArr.join(', ') : 'Ninguno';
        calcularMonto(); // Recalcula el monto cuando cambia la selecci√≥n
    }

    // Nueva funci√≥n para enviar datos a Google Apps Script (modificada para loader y GET/POST)
    async function enviarDatosAAppsScript(data, sheetName, method = "POST") {
        showLoader();
        const formData = new FormData();
        for (const key in data) {
            formData.append(key, data[key]);
        }
        formData.append("sheet", sheetName);

        let url = SCRIPT_URL;
        if (method === "GET") {
            // Para solicitudes GET que usan par√°metros de acci√≥n, se a√±aden a la URL
            // El `sheetName` aqu√≠ es el `action` en el Apps Script para doGet
            // Por ejemplo, para obtener tickets vendidos, se pasar√≠a `action=getSoldTickets`
            // Y para la tasa, `action=getDollarRate`
            // La funci√≥n `obtenerTasaDolar` ya maneja su propio fetch
            // Esta funci√≥n `enviarDatosAAppsScript` se usa para `getSoldTickets` (GET)
            // y para `TicketsComprados` y `ReportesDePago` (POST)
            url += "?" + new URLSearchParams(formData).toString();
        }

        try {
            const response = await fetch(url, {
                method: method,
                body: method === "POST" ? formData : null, // Solo body para POST
            });
            const result = await response.json();
            return result;
        } catch (error) {
            console.error("Error al enviar datos a Google Sheets:", error);
            return { status: "error", message: "No se pudo conectar con el servidor de Google Sheets." };
        } finally {
            hideLoader();
        }
    }

    // --- L√≥gica del Modal de Selecci√≥n de Tickets ---
    async function openTicketSelectionModal() {
        showLoader();
        closeModal('comprarModal'); // Cierra el modal de compra temporalmente

        // Obtener tickets vendidos al abrir el modal
        // NOTA: 'TicketsComprados' aqu√≠ es el valor del par√°metro 'sheet' para doPost,
        // pero para doGet, se espera 'action'. La funci√≥n 'enviarDatosAAppsScript'
        // debe ajustarse para enviar 'action=getSoldTickets' en lugar de 'sheet=TicketsComprados'
        // si el doGet se usa para ambos.
        // A la luz del Apps Script proporcionado, la llamada para getSoldTickets deber√≠a ser:
        const result = await enviarDatosAAppsScript({action: "getSoldTickets"}, "", "GET"); // Se pasa 'action' y sheetName vac√≠o

        if (result.status === "success") {
            soldTickets = new Set(result.soldTickets); // Actualiza la lista de tickets vendidos
            renderTicketGrid(); // Renderiza la cuadr√≠cula de tickets
            
            // Restaurar la selecci√≥n actual del usuario si ya hab√≠a seleccionado algo antes de cerrar
            const currentSelectedTicketsArr = Array.from(selectedTickets);
            selectedTickets.clear(); // Limpiar y volver a seleccionar para asegurar que el DOM refleje
            currentSelectedTicketsArr.forEach(ticketNum => {
                const ticketElement = document.getElementById(`ticket-${ticketNum}`);
                if (ticketElement && !ticketElement.classList.contains('sold')) {
                    ticketElement.classList.add('selected');
                    selectedTickets.add(ticketNum);
                }
            });
            updateModalSelectedTicketsDisplay();
            openModal('ticketSelectionModal'); // Abre el modal de tickets
        } else {
            alert("Error al cargar la lista de tickets: " + result.message);
            openModal('comprarModal'); // Vuelve al modal de compra si falla
        }
    }

    function renderTicketGrid() {
        const ticketGrid = document.getElementById('ticketGrid');
        ticketGrid.innerHTML = ''; // Limpiar cuadr√≠cula existente

        for (let i = 1; i <= TOTAL_TICKETS; i++) {
            const ticketDiv = document.createElement('div');
            ticketDiv.id = `ticket-${i}`;
            ticketDiv.className = 'ticket-item';
            ticketDiv.innerText = i;

            if (soldTickets.has(i)) {
                ticketDiv.classList.add('sold');
            } else {
                ticketDiv.classList.add('available');
                ticketDiv.onclick = () => toggleTicketSelection(i, ticketDiv);
            }
            ticketGrid.appendChild(ticketDiv);
        }
    }

    function toggleTicketSelection(ticketNum, element) {
        if (element.classList.contains('sold')) {
            // No hacer nada si el ticket est√° vendido
            return;
        }

        if (selectedTickets.has(ticketNum)) {
            selectedTickets.delete(ticketNum);
            element.classList.remove('selected');
            element.classList.add('available');
        } else {
            selectedTickets.add(ticketNum);
            element.classList.add('selected');
            element.classList.remove('available');
        }
        updateModalSelectedTicketsDisplay();
    }

    function updateModalSelectedTicketsDisplay() {
        const display = document.getElementById('currentSelectedTickets');
        const countDisplay = document.getElementById('currentTicketsCount');
        const selectedArr = Array.from(selectedTickets).sort((a, b) => a - b);
        display.innerText = selectedArr.length > 0 ? selectedArr.join(', ') : 'Ninguno';
        countDisplay.innerText = `${selectedArr.length} ticket(s) seleccionado(s)`;
    }

    function confirmTicketSelection() {
        if (selectedTickets.size < MIN_TICKETS_PURCHASE) {
            alert(`Debe seleccionar al menos ${MIN_TICKETS_PURCHASE} tickets.`);
            return;
        }
        updateSelectedTicketsInfo(); // Actualiza la informaci√≥n en el modal de compra
        closeModal('ticketSelectionModal');
        openModal('comprarModal'); // Vuelve al modal de compra
    }

    function cancelTicketSelection() {
        // Al cancelar, descartar la selecci√≥n actual
        selectedTickets.clear(); // Limpiar la selecci√≥n si el usuario cancela
        updateSelectedTicketsInfo(); // Actualizar el display principal
        closeModal('ticketSelectionModal');
        openModal('comprarModal');
    }

    // --- Fin L√≥gica del Modal de Selecci√≥n de Tickets ---

    // Funci√≥n para copiar datos al portapapeles
    function copyToClipboard(text, messageElementId) {
        navigator.clipboard.writeText(text).then(() => {
            const messageElement = document.getElementById(messageElementId);
            messageElement.textContent = '¬°Copiado!';
            setTimeout(() => {
                messageElement.textContent = '';
            }, 2000); // El mensaje desaparece despu√©s de 2 segundos
        }).catch(err => {
            console.error('Error al copiar: ', err);
            alert('Error al copiar los datos. Por favor, int√©ntalo manualmente.');
        });
    }

    // Funci√≥n para manejar la copia de datos de Pago M√≥vil
    function copyPaymentData(type) {
        let dataToCopy = '';
        let messageElementId = '';
        const monto = document.getElementById('montoDisplay').textContent.replace('Monto a pagar: ', ''); // Obtiene el monto del display general

        if (type === 'pm1') {
            const bank = document.getElementById('pm1Bank').textContent;
            const cedula = document.getElementById('pm1Cedula').textContent;
            const phone = document.getElementById('pm1Phone').textContent;
            dataToCopy = `Pago M√≥vil (${bank}):\nBanco: ${bank}\nC√©dula: ${cedula}\nTel√©fono: ${phone}\nMonto: ${monto}`;
            messageElementId = 'pm1CopyMessage';
        } else if (type === 'pm2') {
            const bank = document.getElementById('pm2Bank').textContent;
            const cedula = document.getElementById('pm2Cedula').textContent;
            const phone = document.getElementById('pm2Phone').textContent;
            dataToCopy = `Pago M√≥vil (${bank}):\nBanco: ${bank}\nC√©dula: ${cedula}\nTel√©fono: ${phone}\nMonto: ${monto}`;
            messageElementId = 'pm2CopyMessage';
        }
        copyToClipboard(dataToCopy, messageElementId);
    }

    // L√≥gica para el nuevo flujo de "Pagar" y "Enviar Registros"
    document.addEventListener('DOMContentLoaded', function() {
        const raffleForm = document.getElementById('raffleForm');
        const showPaymentDetailsBtn = document.getElementById('showPaymentDetailsBtn'); // Bot√≥n "Pagar"
        const submitRaffleFormBtn = document.getElementById('submitRaffleFormBtn'); // Bot√≥n "Enviar Registros"
        const paymentOptionsContainer = document.getElementById('paymentOptionsContainer'); // Nuevo contenedor de opciones de pago
        const raffleFormResponseMessage = document.getElementById('raffleFormResponseMessage'); // Mensajes del formulario de compra

        // Inicializar los valores fijos de pago m√≥vil
        document.getElementById('pm1Bank').textContent = bankPM1;
        document.getElementById('pm1Cedula').textContent = cedulaPM1;
        document.getElementById('pm1Phone').textContent = telefonoPM1;

        document.getElementById('pm2Bank').textContent = bankPM2;
        document.getElementById('pm2Cedula').textContent = cedulaPM2;
        document.getElementById('pm2Phone').textContent = telefonoPM2;

        // Evento para mostrar las opciones de pago y el bot√≥n de enviar
        showPaymentDetailsBtn.addEventListener('click', function(event) {
            // Validaci√≥n de campos del formulario antes de mostrar el pago
            if (!raffleForm.checkValidity()) { 
                raffleForm.reportValidity(); // Muestra mensajes de error del navegador
                raffleFormResponseMessage.textContent = 'Por favor, completa todos los campos requeridos y selecciona tus tickets antes de proceder al pago.';
                raffleFormResponseMessage.style.color = 'red';
                raffleFormResponseMessage.style.backgroundColor = '#ffe0e0';
                return;
            }

            // Validar que se hayan seleccionado tickets
            if (selectedTickets.size < MIN_TICKETS_PURCHASE) {
                alert(`Por favor, selecciona al menos ${MIN_TICKETS_PURCHASE} tickets antes de proceder al pago.`);
                raffleFormResponseMessage.textContent = `Por favor, selecciona al menos ${MIN_TICKETS_PURCHASE} tickets.`;
                raffleFormResponseMessage.style.color = 'orange';
                raffleFormResponseMessage.style.backgroundColor = '#fff3cd';
                return;
            }

            // Si todas las validaciones pasan, muestra la informaci√≥n de pago y el bot√≥n de enviar
            paymentOptionsContainer.style.display = 'block'; // Muestra el nuevo contenedor de opciones de pago
            submitRaffleFormBtn.style.display = 'block'; // Muestra el bot√≥n de enviar
            showPaymentDetailsBtn.style.display = 'none'; // Oculta el bot√≥n de "Pagar"
            showPaymentDetailsBtn.disabled = false; // Asegura que no est√© deshabilitado
            raffleFormResponseMessage.textContent = ''; // Limpia mensajes previos
            raffleFormResponseMessage.style.backgroundColor = 'transparent';
            raffleFormResponseMessage.style.color = 'black';
            calcularMonto(); // Asegura que el monto est√© actualizado en las opciones de pago
        });

        // Evento para enviar el formulario a Google Apps Script (cuando se presiona "Enviar Registros")
        raffleForm.addEventListener('submit', async function(event) {
            event.preventDefault(); // Evita el env√≠o tradicional del formulario HTML

            raffleFormResponseMessage.textContent = 'Enviando tus registros... por favor espera.';
            raffleFormResponseMessage.style.color = 'blue';
            raffleFormResponseMessage.style.backgroundColor = '#e0f7fa'; 
            
            // Deshabilitar botones para evitar env√≠os m√∫ltiples
            showPaymentDetailsBtn.disabled = true;
            submitRaffleFormBtn.disabled = true;

            // Recopilar datos del formulario
            const nombre = document.getElementById("nombre").value.trim();
            const apellido = document.getElementById("apellido").value.trim();
            const cedula = document.getElementById("cedula").value.trim();
            const telefono = document.getElementById("telefono").value.trim();
            const correo = document.getElementById("correo").value.trim();
            const montoBsText = document.getElementById("montoDisplay").innerText;
            const montoBs = parseFloat(montoBsText.replace('Monto a pagar: Bs. ', ''));

            const purchaseData = {
                nombre,
                apellido,
                cedula,
                telefono,
                correo,
                selectedTickets: Array.from(selectedTickets).join(','), // Enviar los tickets seleccionados como CSV
                montoBs
            };

            const result = await enviarDatosAAppsScript(purchaseData, "TicketsComprados", "POST");

            if (result.status === "success") {
                raffleFormResponseMessage.textContent = '¬°Registros enviados con √©xito! Despu√©s de validar su pago, recibir√° un correo con sus tickets solicitados. ¬°Mucha suerte!';
                raffleFormResponseMessage.style.color = 'green';
                raffleFormResponseMessage.style.backgroundColor = '#e8f5e9'; 

                // Limpiar formulario despu√©s del env√≠o exitoso
                raffleForm.reset(); 
                selectedTickets.clear(); // Limpiar la selecci√≥n de tickets
                updateSelectedTicketsInfo(); // Actualizar el display de tickets
                
                paymentOptionsContainer.style.display = 'none'; // Oculta las opciones de pago
                submitRaffleFormBtn.style.display = 'none'; // Oculta el bot√≥n de enviar
                showPaymentDetailsBtn.style.display = 'block'; // Vuelve a mostrar el bot√≥n de "Pagar"
                showPaymentDetailsBtn.disabled = false; // Habilita el bot√≥n de "Pagar"
                
            } else {
                raffleFormResponseMessage.textContent = `Error al enviar los registros: ${result.message || 'Int√©ntelo de nuevo.'}`;
                raffleFormResponseMessage.style.color = 'red';
                raffleFormResponseMessage.style.backgroundColor = '#ffe0e0';
                
                // Re-habilitar botones para permitir reintentar
                showPaymentDetailsBtn.disabled = false;
                submitRaffleFormBtn.disabled = false;
            }
        });
    });

    // Funci√≥n para enviar datos del reporte de pago (mantener tal cual)
    async function enviarReporte() {
        const cedula = document.getElementById("cedulaReporte").value.trim();
        const telefono = document.getElementById("telefonoReporte").value.trim();
        const correo = document.getElementById("correoReporte").value.trim(); // Obtener el correo
        const referencia = document.getElementById("referencia").value.trim();
        const bancoEmisor = document.getElementById("bancoEmisor").value;

        if (!cedula || !telefono || !correo || !referencia || bancoEmisor === "Seleccione banco emisor" || bancoEmisor === "") {
            alert("Por favor, complete todos los campos del reporte correctamente.");
            return;
        }

        // Datos a enviar para el reporte de pago
        const reportData = {
            cedula,
            telefono,
            correo, // Incluir correo en los datos del reporte
            referencia,
            bancoEmisor
        };

        const result = await enviarDatosAAppsScript(reportData, "ReportesDePago", "POST");

        if (result.status === "success") {
            alert("¬°Reporte de pago enviado con √©xito! Gracias por su informaci√≥n.");
            closeModal("reportModal");
            // Limpiar los campos del formulario de reporte
            document.getElementById("cedulaReporte").value = '';
            document.getElementById("telefonoReporte").value = '';
            document.getElementById("correoReporte").value = ''; // Limpiar el correo
            document.getElementById("referencia").value = '';
            document.getElementById("bancoEmisor").value = "";
        } else {
            alert("Error al enviar el reporte de pago: " + result.message);
        }
    }

    // Ocultar el loader inicial cuando el DOM est√© completamente cargado y obtener la tasa del d√≥lar
    document.addEventListener('DOMContentLoaded', () => {
        obtenerTasaDolar().finally(() => {
            setTimeout(hideLoader, 500); // Peque√±o retraso para una mejor experiencia visual
        });
    });

</script>

</body>
</html>
